<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <link rel="stylesheet" href="/bootstrap.min.css" />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
      rel="stylesheet"
    />
    <link href="/styles.css" rel="stylesheet" />
  </head>
  <body>
    <div class="container-fluid">
      <div class="row">
        <!-- Sidebar -->
        <div class="col-md-3 col-lg-2">
          <div class="sidebar">
            <div class="p-3">
              <h3 class="text-center mb-4">
                <a href="index.html" class="text-decoration-none text-dark">
                  <img src="/Logo.png" alt="logo" style="width: 60px; height: auto;"> Woodcarving
                </a>
              </h3>
            </div>
            <nav class="nav flex-column accordion" id="sidebarAccordion">
              <!-- System Menu -->
              <div class="accordion-item border-0">
                <h2 class="accordion-header" id="headingSystem">
                  <button
                    class="accordion-button bg-light text-dark fw-semibold"
                    type="button"
                    data-bs-toggle="collapse"
                    data-bs-target="#collapseSystem"
                    aria-expanded="true"
                    aria-controls="collapseSystem"
                  >
                    <i class="fas fa-cogs me-2"></i> System
                  </button>
                </h2>
                <div
                  id="collapseSystem"
                  class="accordion-collapse collapse show"
                  aria-labelledby="headingSystem"
                >
                  <div class="accordion-body py-2">
                    <ul class="list-unstyled ps-3 small">
                      <li data-role-required="MANAGER,ADMIN">
                        <a class="nav-link text-dark" href="user-Index.html"
                          ><i class="fas fa-users me-2"></i> User Profile</a
                        >
                      </li>
                      <li>
                        <a class="nav-link text-dark" href="supplier-index.html"
                          ><i class="fas fa-truck me-2"></i> Supplier Profile</a
                        >
                      </li>
                      <li>
                        <a class="nav-link text-dark" href="customer-index.html"
                          ><i class="fas fa-user-friends me-2"></i> Customer
                          Profile</a
                        >
                      </li>
                    </ul>
                  </div>
                </div>
              </div>

              <!-- Maintain Menu -->
              <div class="accordion-item border-0">
                <h2 class="accordion-header" id="headingMaintain">
                  <button
                    class="accordion-button bg-light text-dark fw-semibold"
                    type="button"
                    data-bs-toggle="collapse"
                    data-bs-target="#collapseMaintain"
                    aria-expanded="true"
                    aria-controls="collapseMaintain"
                  >
                    <i class="fas fa-wrench me-2"></i> Inventory
                  </button>
                </h2>
                <div
                  id="collapseMaintain"
                  class="accordion-collapse collapse show"
                  aria-labelledby="headingMaintain"
                >
                  <div class="accordion-body py-2">
                    <ul class="list-unstyled ps-3 small">
                      <li>
                        <a href="item-index.html" class="nav-link text-dark"
                          ><i class="fas fa-hammer me-2"></i> Item Profile</a
                        >
                      </li>
                      <li>
                        <a href="purchaseOrder-index.html" class="nav-link text-dark"
                          ><i class="fas fa-shopping-cart me-2"></i> Purchase
                          Order</a
                        >
                      </li>
                      <li>
                        <a href="grn-index.html" class="nav-link text-dark"
                          ><i class="fas fa-receipt me-2"></i> G.R.N</a
                        >
                      </li>
                    </ul>
                  </div>
                </div>
              </div>

              <!-- Tasks Menu -->
              <div class="accordion-item border-0">
                <h2 class="accordion-header" id="headingTasks">
                  <button
                    class="accordion-button bg-light text-dark fw-semibold"
                    type="button"
                    data-bs-toggle="collapse"
                    data-bs-target="#collapseTasks"
                    aria-expanded="true"
                    aria-controls="collapseTasks"
                  >
                    <i class="fas fa-receipt me-2"></i> Sales
                  </button>
                </h2>
                <div
                  id="collapseTasks"
                  class="accordion-collapse collapse show"
                  aria-labelledby="headingTasks"
                >
                  <div class="accordion-body py-2">
                    <ul class="list-unstyled ps-3 small">
                      <li>
                        <a href="salesOrder-index.html" class="nav-link text-dark"
                          ><i class="fas fa-shopping-bag me-2"></i> Sales
                          Order</a
                        >
                      </li>
                      <li>
                        <a href="invoice-index.html" class="nav-link text-dark"
                          ><i class="fas fa-file-invoice me-2"></i> Invoice</a
                        >
                      </li>
                    </ul>
                  </div>
                </div>
              </div>
            </nav>
          </div>
        </div>

        <!-- Main Content -->
        <div class="col-md-9 col-lg-10">
          <div class="main-content container-fluid">
            <div class="row">
              <div class="col-lg-12">
                <div class="card">
                  <div class="card-header">
                    <h5>Good Receive Note</h5>
                  </div>
                  <div class="card-body">
                    <div id="errorMessage" class="alert alert-danger d-none" role="alert"></div>
                    <div id="successMessage" class="alert alert-success d-none" role="alert"></div>
                    <form id="grnForm">
                      <div class="row">
                        <div class="col-md-2 mb-3">
                          <label for="grnNumber" class="form-label">GRN Number</label>
                          <input
                                  type="text"
                                  class="form-control"
                                  id="grnNumber"
                                  readonly
                                  placeholder="Auto-generated"
                            />
                        </div>
                        <div class="col-md-3 mb-3">
                          <label for="purchaseOrder" class="form-label"
                            >Purchase Order</label>
                          <select class="form-select" id="purchaseOrder" required>
                              <option value="">Select Purchase Order</option>
                          </select>
                        </div>
                        <div class="col-md-2 mb-3">
                          <label for="supName" class="form-label">Supplier Name</label>
                          <input
                                  type="text"
                                  class="form-control"
                                  id="supName"
                                  readonly
                                  placeholder="Auto-filled"
                            />
                        </div>
                        <div class="col-md-2 mb-3">
                          <label for="receivedDate" class="form-label">Received Date</label>
                          <input
                                  type="date"
                                  class="form-control"
                                  id="receivedDate"
                                  required
                            />
                        </div>
                        <div class="col-md-3 mb-3">
                          <label for="receivedBy" class="form-label">Received By</label>
                          <input
                                  type="text"
                                  class="form-control"
                                  id="receivedBy"
                                  readonly
                                  placeholder="Auto-filled(User)"
                            />
                        </div>
                      </div>
                      <div class="row">
                        <div class="col-md-3 mb-3">
                          <label for="deliveryNote" class="form-label"
                            >Delivery Note Number</label>
                          <input
                                  type="text"
                                  class="form-control"
                                  id="deliveryNote"
                                  placeholder="Enter delivery note number"
                            />
                        </div>
                        <div class="col-md-9 mb-3">
                          <label for="remarks" class="form-label">Remarks</label>
                          <textarea
                                  class="form-control"
                                  id="remarks"
                                  rows="2"
                                  placeholder="Enter any remarks"
                            ></textarea>
                        </div>
                      </div>
                      <div class="row">
                        <div class="card mt-4">
                          <div class="card-header">
                            <h6>Ordered Items</h6>
                          </div>
                          <div class="card-body">
                            <table class="table table-bordered" id="itemsTable">
                              <thead>
                                <tr>
                                  <th scope="col">Item</th>
                                  <th scope="col">Ordered Qty</th>
                                  <th scope="col">Received Qty</th>
                                  <th scope="col">Rejected Qty</th>
                                  <th scope="col">Accepted Qty</th>
                                </tr>
                              </thead>
                              <tbody id="itemsTableBody">
                                <tr>
                                  <td colspan="5" class="text-center text-muted">Select a Purchase Order to load items</td>
                                </tr>
                              </tbody>
                            </table>
                          </div>
                        </div>
                        <div class="row">
                            <div class="col-md-3 mt-3 offset-md-9">
                              <button type="submit" class="btn btn-primary w-100" id="submitBtn">
                                <span id="submitBtnText">Save</span>
                              </button>
                              <button type="button" class="btn btn-success w-100 mt-2 d-none" id="completeBtn" data-role-required="MANAGER,ADMIN">
                                Complete GRN
                              </button>
                              <button type="button" class="btn btn-secondary w-100 mt-2 d-none" id="cancelBtn">
                                Cancel
                              </button>
                            </div>
                          </div>
                      </div>
                    </form>
                  </div>
                  
                </div>
              </div>
            </div>

            <div class="row mt-4">
              <div class="col-lg-12">
                <div class="card">
                  <div class="card-header">
                    <h5>GRNs</h5>
                  </div>
                  <div class="card-body">
                    <table class="table table-striped">
                      <thead>
                        <tr>
                          <th scope="col">GRN Number</th>
                          <th scope="col">Purchase Order</th>
                          <th scope="col">Supplier Name</th>
                          <th scope="col">Received Date</th>
                          <th scope="col">Received By</th>
                          <th scope="col">Delivery Note</th>
                          <th scope="col">Remarks</th>
                          <th scope="col">Status</th>
                          <th scope="col">Actions</th>
                        </tr>
                      </thead>
                      <tbody id="grnTableBody">
                        <tr>
                          <td colspan="9" class="text-center">Loading...</td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="/bootstrap.min.js"></script>
    <script src="/api.js"></script>
    <script>
        let editingGRNId = null;
        let selectedPurchaseOrder = null;
        let currentUser = utils.getCurrentUser();
        
        // Set current user and default date
        if (currentUser) {
            document.getElementById('receivedBy').value = currentUser.fullName || currentUser.username;
        }
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('receivedDate').value = today;
        
        // Load purchase orders and GRNs
        loadPurchaseOrders();
        loadGRNs();
        
        // Load purchase orders
        async function loadPurchaseOrders() {
            try {
                const result = await api.purchaseOrder.getAll();
                if (result.success && result.data) {
                    const select = document.getElementById('purchaseOrder');
                    select.innerHTML = '<option value="">Select Purchase Order</option>';
                    result.data.filter(po => po.status !== 'RECEIVED' && po.status !== 'CANCELLED').forEach(po => {
                        const option = document.createElement('option');
                        option.value = po.id;
                        option.textContent = `${po.orderNumber || 'PO-' + po.id} - ${po.supplier ? po.supplier.name : 'N/A'}`;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading purchase orders:', error);
            }
        }
        
        // Purchase order change handler
        document.getElementById('purchaseOrder').addEventListener('change', async function() {
            const poId = this.value;
            if (poId) {
                await loadPurchaseOrderItems(poId);
            } else {
                document.getElementById('itemsTableBody').innerHTML = 
                    '<tr><td colspan="5" class="text-center text-muted">Select a Purchase Order to load items</td></tr>';
                document.getElementById('supName').value = '';
            }
        });
        
        // Load purchase order items
        async function loadPurchaseOrderItems(poId) {
            try {
                const result = await api.purchaseOrder.getById(poId);
                if (result.success) {
                    selectedPurchaseOrder = result.data;
                    document.getElementById('supName').value = selectedPurchaseOrder.supplier ? selectedPurchaseOrder.supplier.name : '';
                    
                    const tbody = document.getElementById('itemsTableBody');
                    if (selectedPurchaseOrder.items && selectedPurchaseOrder.items.length > 0) {
                        tbody.innerHTML = selectedPurchaseOrder.items.map(item => `
                            <tr data-product-id="${item.productId}">
                                <td>${item.product ? item.product.name : 'N/A'}</td>
                                <td class="ordered-qty">${item.quantity}</td>
                                <td>
                                    <input type="number" class="form-control received-qty-input" 
                                           min="0" max="${item.quantity}" value="${item.quantity}" 
                                           data-ordered="${item.quantity}" required>
                                </td>
                                <td>
                                    <input type="number" class="form-control rejected-qty-input" 
                                           min="0" max="${item.quantity}" value="0" 
                                           data-ordered="${item.quantity}" required>
                                </td>
                                <td class="accepted-qty">${item.quantity}</td>
                            </tr>
                        `).join('');
                        
                        // Add event listeners for quantity calculations
                        document.querySelectorAll('.received-qty-input, .rejected-qty-input').forEach(input => {
                            input.addEventListener('input', calculateAcceptedQty);
                        });
                    } else {
                        tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No items found</td></tr>';
                    }
                }
            } catch (error) {
                console.error('Error loading purchase order items:', error);
                showError('Error loading purchase order items');
            }
        }
        
        // Calculate accepted quantity
        function calculateAcceptedQty(event) {
            const row = event.target.closest('tr');
            const receivedInput = row.querySelector('.received-qty-input');
            const rejectedInput = row.querySelector('.rejected-qty-input');
            const acceptedCell = row.querySelector('.accepted-qty');
            
            const received = parseInt(receivedInput.value) || 0;
            const rejected = parseInt(rejectedInput.value) || 0;
            const ordered = parseInt(receivedInput.getAttribute('data-ordered')) || 0;
            
            // Validate received quantity doesn't exceed ordered
            if (received > ordered) {
                receivedInput.value = ordered;
                received = ordered;
            }
            
            // Validate rejected doesn't exceed received
            if (rejected > received) {
                rejectedInput.value = received;
                rejected = received;
            }
            
            const accepted = received - rejected;
            acceptedCell.textContent = accepted;
        }
        
        // Form submit
        document.getElementById('grnForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (!selectedPurchaseOrder) {
                showError('Please select a Purchase Order');
                return;
            }
            
            const items = [];
            document.querySelectorAll('#itemsTableBody tr').forEach(row => {
                const productId = row.getAttribute('data-product-id');
                const orderedQty = parseInt(row.querySelector('.ordered-qty').textContent);
                const receivedQty = parseInt(row.querySelector('.received-qty-input').value) || 0;
                const rejectedQty = parseInt(row.querySelector('.rejected-qty-input').value) || 0;
                const acceptedQty = receivedQty - rejectedQty;
                
                // Find unit price from purchase order item
                const poItem = selectedPurchaseOrder.items.find(item => item.productId == productId);
                const unitPrice = poItem ? poItem.unitPrice : 0;
                
                if (productId && receivedQty > 0) {
                    items.push({
                        productId: parseInt(productId),
                        orderedQuantity: orderedQty,
                        receivedQuantity: receivedQty,
                        unitPrice: unitPrice
                    });
                }
            });
            
            if (items.length === 0) {
                showError('Please enter received quantities');
                return;
            }
            
            const grnData = {
                purchaseOrderId: selectedPurchaseOrder.id,
                receivedDate: document.getElementById('receivedDate').value + 'T00:00:00',
                notes: document.getElementById('remarks').value || '',
                items: items
            };
            
            try {
                let result;
                if (editingGRNId) {
                    result = await api.grn.update(editingGRNId, grnData);
                } else {
                    result = await api.grn.create(grnData);
                }
                
                if (result.success) {
                    utils.showNotification(editingGRNId ? 'GRN updated successfully!' : 'GRN created successfully!', 'success');
                    resetForm();
                    loadGRNs();
                } else {
                    showError(result.error || 'Failed to save GRN');
                }
            } catch (error) {
                showError('An error occurred. Please try again.');
            }
        });
        
        // Complete GRN button
        document.getElementById('completeBtn').addEventListener('click', async function() {
            if (confirm('Complete this GRN? This will update product stock.')) {
                try {
                    const result = await api.grn.complete(editingGRNId);
                    if (result.success) {
                        utils.showNotification('GRN completed successfully! Stock updated.', 'success');
                        resetForm();
                        loadGRNs();
                    } else {
                        showError(result.error || 'Failed to complete GRN');
                    }
                } catch (error) {
                    showError('Error completing GRN: ' + error.message);
                }
            }
        });
        
        // Load GRNs
        async function loadGRNs() {
            try {
                const result = await api.grn.getAll();
                const tbody = document.getElementById('grnTableBody');
                
                    if (result.success && result.data && result.data.length > 0) {
                    tbody.innerHTML = result.data.map(grn => `
                        <tr>
                            <td>${grn.grnNumber || 'N/A'}</td>
                            <td>${grn.purchaseOrder ? grn.purchaseOrder.orderNumber : 'N/A'}</td>
                            <td>${grn.purchaseOrder && grn.purchaseOrder.supplier ? grn.purchaseOrder.supplier.name : 'N/A'}</td>
                            <td>${formatDate(grn.receivedDate)}</td>
                            <td>${currentUser ? (currentUser.fullName || currentUser.username) : 'N/A'}</td>
                            <td>${grn.deliveryNoteNumber || 'N/A'}</td>
                            <td>${grn.notes || 'N/A'}</td>
                            <td>
                                <span class="badge bg-${grn.status === 'COMPLETED' ? 'success' : 'warning'}">${grn.status || 'PENDING'}</span>
                            </td>
                            <td>
                                ${grn.status !== 'COMPLETED' ? `<button class="btn btn-sm btn-success me-2" data-role-required="MANAGER,ADMIN" onclick="completeGRN(${grn.id})">Complete</button>` : ''}
                                <button class="btn btn-sm btn-danger" onclick="deleteGRN(${grn.id})">Delete</button>
                            </td>
                        </tr>
                    `).join('');
                } else {
                    tbody.innerHTML = '<tr><td colspan="9" class="text-center text-muted">No GRNs found</td></tr>';
                }
            } catch (error) {
                document.getElementById('grnTableBody').innerHTML = 
                    '<tr><td colspan="9" class="text-center text-danger">Error loading GRNs</td></tr>';
            }
        }
        
        // Complete GRN
        async function completeGRN(id) {
            if (confirm('Complete this GRN? This will update product stock.')) {
                try {
                    const result = await api.grn.complete(id);
                    if (result.success) {
                        utils.showNotification('GRN completed successfully! Stock updated.', 'success');
                        loadGRNs();
                    } else {
                        showError(result.error || 'Failed to complete GRN');
                    }
                } catch (error) {
                    showError('Error completing GRN: ' + error.message);
                }
            }
        }
        
        // Delete GRN
        async function deleteGRN(id) {
            if (confirm('Are you sure you want to delete this GRN?')) {
                try {
                    const result = await api.grn.delete(id);
                    if (result && result.success) {
                        utils.showNotification('GRN deleted successfully!', 'success');
                        loadGRNs();
                    } else {
                        utils.showNotification('GRN deleted successfully!', 'success');
                        loadGRNs();
                    }
                } catch (error) {
                    showError('Error deleting GRN: ' + error.message);
                }
            }
        }
        
        // Reset form
        function resetForm() {
            editingGRNId = null;
            selectedPurchaseOrder = null;
            document.getElementById('grnForm').reset();
            document.getElementById('itemsTableBody').innerHTML = 
                '<tr><td colspan="5" class="text-center text-muted">Select a Purchase Order to load items</td></tr>';
            document.getElementById('receivedDate').value = today;
            if (currentUser) {
                document.getElementById('receivedBy').value = currentUser.fullName || currentUser.username;
            }
            document.getElementById('submitBtnText').textContent = 'Save';
            document.getElementById('completeBtn').classList.add('d-none');
            document.getElementById('cancelBtn').classList.add('d-none');
            hideMessages();
        }
        
        // Cancel edit
        document.getElementById('cancelBtn').addEventListener('click', resetForm);
        
        // Helper functions
        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            return date.toLocaleDateString();
        }
        
        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.classList.remove('d-none');
            document.getElementById('successMessage').classList.add('d-none');
        }
        
        function hideMessages() {
            document.getElementById('errorMessage').classList.add('d-none');
            document.getElementById('successMessage').classList.add('d-none');
        }
    </script>
  </body>
</html>
