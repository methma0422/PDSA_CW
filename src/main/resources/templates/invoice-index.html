<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Invoice</title>
    <link rel="stylesheet" href="/bootstrap.min.css" />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
      rel="stylesheet"
    />
    <link href="/styles.css" rel="stylesheet" />
  </head>
  <body>
    <div class="container-fluid">
      <div class="row">
        <!-- Sidebar -->
        <div class="col-md-3 col-lg-2">
          <div class="sidebar">
            <div class="p-3">
              <h3 class="text-center mb-4">
                <a href="index.html" class="text-decoration-none text-dark">
                  <img src="/Logo.png" alt="logo" style="width: 60px; height: auto;"> Woodcarving
                </a>
              </h3>
            </div>
            <nav class="nav flex-column accordion" id="sidebarAccordion" style="background-color: #E5E4E2;">
              <!-- System Menu -->
              <div class="accordion-item border-0">
                <h2 class="accordion-header" id="headingSystem">
                  <button
                    class="accordion-button bg-light text-dark fw-semibold"
                    type="button"
                    data-bs-toggle="collapse"
                    data-bs-target="#collapseSystem"
                    aria-expanded="true"
                    aria-controls="collapseSystem"
                  >
                    <i class="fas fa-cogs me-2"></i> System
                  </button>
                </h2>
                <div
                  id="collapseSystem"
                  class="accordion-collapse collapse show"
                  aria-labelledby="headingSystem"
                >
                  <div class="accordion-body py-2">
                    <ul class="list-unstyled ps-3 small">
                      <li>
                        <a class="nav-link text-dark" href="user-Index.html"
                          ><i class="fas fa-users me-2"></i> User Profile</a
                        >
                      </li>
                      <li>
                        <a class="nav-link text-dark" href="supplier-index.html"
                          ><i class="fas fa-truck me-2"></i> Supplier Profile</a
                        >
                      </li>
                      <li>
                        <a class="nav-link text-dark" href="customer-index.html"
                          ><i class="fas fa-user-friends me-2"></i> Customer
                          Profile</a
                        >
                      </li>
                    </ul>
                  </div>
                </div>
              </div>

              <!-- Maintain Menu -->
              <div class="accordion-item border-0">
                <h2 class="accordion-header" id="headingMaintain">
                  <button
                    class="accordion-button bg-light text-dark fw-semibold"
                    type="button"
                    data-bs-toggle="collapse"
                    data-bs-target="#collapseMaintain"
                    aria-expanded="true"
                    aria-controls="collapseMaintain"
                  >
                    <i class="fas fa-wrench me-2"></i> Inventory
                  </button>
                </h2>
                <div
                  id="collapseMaintain"
                  class="accordion-collapse collapse show"
                  aria-labelledby="headingMaintain"
                >
                  <div class="accordion-body py-2">
                    <ul class="list-unstyled ps-3 small">
                      <li>
                        <a href="item-index.html" class="nav-link text-dark"
                          ><i class="fas fa-hammer me-2"></i> Item Profile</a
                        >
                      </li>
                      <li>
                        <a href="purchaseOrder-index.html" class="nav-link text-dark"
                          ><i class="fas fa-shopping-cart me-2"></i> Purchase
                          Order</a
                        >
                      </li>
                      <li>
                        <a href="grn-index.html" class="nav-link text-dark"
                          ><i class="fas fa-receipt me-2"></i> G.R.N</a
                        >
                      </li>
                    </ul>
                  </div>
                </div>
              </div>

              <!-- Tasks Menu -->
              <div class="accordion-item border-0">
                <h2 class="accordion-header" id="headingTasks">
                  <button
                    class="accordion-button bg-light text-dark fw-semibold"
                    type="button"
                    data-bs-toggle="collapse"
                    data-bs-target="#collapseTasks"
                    aria-expanded="true"
                    aria-controls="collapseTasks"
                  >
                    <i class="fas fa-receipt me-2"></i> Sales
                  </button>
                </h2>
                <div
                  id="collapseTasks"
                  class="accordion-collapse collapse show"
                  aria-labelledby="headingTasks"
                >
                  <div class="accordion-body py-2">
                    <ul class="list-unstyled ps-3 small">
                      <li>
                        <a href="salesOrder-index.html" class="nav-link text-dark"
                          ><i class="fas fa-shopping-bag me-2"></i> Sales
                          Order</a
                        >
                      </li>
                      <li>
                        <a href="invoice-index.html" class="nav-link text-dark"
                          ><i class="fas fa-file-invoice me-2"></i> Invoice</a
                        >
                      </li>
                    </ul>
                  </div>
                </div>
              </div>
            </nav>
          </div>
        </div>

        <!-- Main Content -->
        <div class="col-md-9 col-lg-10">
          <div class="main-content p-4">
            <h1>Invoice</h1>

            <!-- Invoice panel (non-destructive, follows existing page pattern) -->
            <div class="card p-3 mt-3" id="invoiceCard">
              <h5 class="mb-3">Create / Checkout Invoice</h5>

              <div class="row mb-3">
                <div class="col-md-8">
                  <select id="soSelect" class="form-select">
                    <option value="">-- Select saved Sales Order --</option>
                  </select>
                </div>
                <div class="col-md-4">
                  <button id="loadSoBtn" class="btn btn-primary w-100">Load Order</button>
                </div>
              </div>

              <form id="invoicePanelForm">
                <div class="row g-3">
                  <div class="col-md-6">
                    <label class="form-label">Invoice No</label>
                    <input id="invNo" class="form-control" readonly />
                  </div>
                  <div class="col-md-6">
                    <label class="form-label">Invoice Date</label>
                    <input id="invDate" type="date" class="form-control" />
                  </div>
                </div>

                <div class="row g-3 mt-3">
                  <div class="col-md-6">
                    <label class="form-label">Sales Order Ref</label>
                    <input id="invSoRef" class="form-control" readonly />
                  </div>
                  <div class="col-md-6">
                    <label class="form-label">Customer Name</label>
                    <input id="invCustName" class="form-control" readonly />
                  </div>
                </div>

                <div class="row g-3 mt-2">
                  <div class="col-md-6">
                    <label class="form-label">Phone</label>
                    <input id="invCustPhone" class="form-control" readonly />
                  </div>
                  <div class="col-md-6">
                    <label class="form-label">Address</label>
                    <input id="invCustAddr" class="form-control" readonly />
                  </div>
                </div>

                <div class="mt-3">
                  <div class="table-responsive">
                    <table class="table table-sm table-bordered" id="invItemsTbl">
                      <thead class="table-light">
                        <tr>
                          <th>Item</th>
                          <th>Description</th>
                          <th style="width:80px">Qty</th>
                          <th style="width:120px">Unit Price</th>
                          <th style="width:120px">Line Total</th>
                        </tr>
                      </thead>
                      <tbody></tbody>
                    </table>
                  </div>

                  <div class="d-flex justify-content-end mt-2">
                    <div style="min-width:220px">
                      <div class="d-flex justify-content-between"><small>Subtotal</small><strong id="invSubtotal">0.00</strong></div>
                      <div class="d-flex justify-content-between"><small>Tax (0%)</small><strong id="invTax">0.00</strong></div>
                      <div class="d-flex justify-content-between mt-2"><span class="h5">Total</span><span id="invTotal" class="h5">0.00</span></div>
                    </div>
                  </div>
                </div>

                <div class="row g-3 mt-3">
                  <div class="col-md-6">
                    <label class="form-label">Payment Method</label>
                    <select id="invPayment" class="form-select">
                      <option value="">-- Select --</option>
                      <option>Cash</option>
                      <option>Credit Card</option>
                      <option>Debit Card</option>
                      <option>Bank Transfer</option>
                      <option>Cheque</option>
                    </select>
                  </div>
                  <div class="col-md-6">
                    <label class="form-label">Transaction Ref (optional)</label>
                    <input id="invTransRef" class="form-control" />
                  </div>
                </div>

                <div class="mt-3 text-end">
                  <button type="button" id="exportInvPdf" class="btn btn-danger me-2">Export PDF</button>
                  <button type="button" id="completeInvBtn" class="btn btn-success" data-role-required="MANAGER,ADMIN">Complete Invoice</button>
                </div>
              </form>
            </div>

            <!-- end invoice panel -->

            <!-- Hidden PDF Template (for export) -->
            <div id="pdfTemplate" style="display: none; padding: 20px; background: white; font-family: Arial, sans-serif; color: #000;">
              <div style="text-align: center; margin-bottom: 30px; border-bottom: 2px solid #000; padding-bottom: 10px;">
                <h2 style="margin: 0; color: #000;">INVOICE</h2>
              </div>
              <div style="margin-bottom: 20px;">
                <div>
                  <p style="margin: 5px 0; color: #000;"><strong>Invoice No:</strong> <span id="pdfInvNo" style="color: #000;">-</span></p>
                  <p style="margin: 5px 0; color: #000;"><strong>Invoice Date:</strong> <span id="pdfInvDate" style="color: #000;">-</span></p>
                  <p style="margin: 5px 0; color: #000;"><strong>Sales Order Ref:</strong> <span id="pdfSoRef" style="color: #000;">-</span></p>
                </div>
              </div>
              <div style="margin-bottom: 20px; border-top: 1px solid #ddd; padding-top: 15px;">
                <h4 style="margin-bottom: 10px; color: #000;">Bill To:</h4>
                <p style="margin: 5px 0; color: #000;"><strong id="pdfCustName" style="color: #000;">-</strong></p>
                <p style="margin: 5px 0; color: #000;" id="pdfCustPhone">-</p>
                <p style="margin: 5px 0; color: #000;" id="pdfCustAddr">-</p>
              </div>
              <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px; border: 1px solid #000;">
                <thead>
                  <tr style="background-color: #f0f0f0;">
                    <th style="border: 1px solid #000; padding: 10px; text-align: left; color: #000; font-weight: bold;">Item</th>
                    <th style="border: 1px solid #000; padding: 10px; text-align: left; color: #000; font-weight: bold;">Description</th>
                    <th style="border: 1px solid #000; padding: 10px; text-align: right; color: #000; font-weight: bold;">Qty</th>
                    <th style="border: 1px solid #000; padding: 10px; text-align: right; color: #000; font-weight: bold;">Unit Price</th>
                    <th style="border: 1px solid #000; padding: 10px; text-align: right; color: #000; font-weight: bold;">Total</th>
                  </tr>
                </thead>
                <tbody id="pdfItemsBody" style="color: #000;">
                  <!-- Items will be populated here -->
                </tbody>
              </table>
              <div style="text-align: right; margin-top: 20px; border-top: 2px solid #000; padding-top: 15px;">
                <p style="margin: 5px 0; color: #000;">Subtotal: <strong id="pdfSubtotal" style="color: #000;">0.00</strong></p>
                <p style="margin: 5px 0; color: #000;">Tax: <strong id="pdfTax" style="color: #000;">0.00</strong></p>
                <p style="margin: 5px 0; color: #000;">Discount: <strong id="pdfDiscount" style="color: #000;">0.00</strong></p>
                <h3 style="margin-top: 15px; color: #000;">Total: <span id="pdfTotal" style="color: #000;">0.00</span></h3>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="/api.js"></script>
    <script>
        // Check if user is logged in
        if (!utils.isLoggedIn()) {
            window.location.href = '/login';
        }
        
      async function loadSalesOrders() {
        const result = await api.salesOrder.getAll();
        const soSelect = document.getElementById('soSelect');
        soSelect.innerHTML = '<option value="">-- Select saved Sales Order --</option>';
        if (result.success && result.data) {
          result.data.forEach(so => {
            const opt = document.createElement('option');
            opt.value = so.id;
            opt.textContent = `${so.orderNumber || ('SO-' + so.id)} - ${so.customer ? so.customer.name : 'N/A'} - ${new Date(so.orderDate).toLocaleDateString()}`;
            soSelect.appendChild(opt);
          });
        }
      }

      async function loadSelectedOrder() {
        const id = document.getElementById('soSelect').value;
        if (!id) return;
        const res = await api.salesOrder.getById(id);
        if (!res.success) return;
        const so = res.data;

        document.getElementById('invNo').value = '';
        document.getElementById('invDate').value = new Date().toISOString().split('T')[0];
        document.getElementById('invSoRef').value = so.orderNumber || ('SO-' + so.id);
        document.getElementById('invCustName').value = so.customer ? so.customer.name : '';
        document.getElementById('invCustPhone').value = so.customer ? (so.customer.phone || '') : '';
        document.getElementById('invCustAddr').value = so.customer ? (so.customer.address || '') : '';

        const tbody = document.querySelector('#invItemsTbl tbody');
        tbody.innerHTML = '';
        let subtotal = 0;
        
        if (so.items && so.items.length > 0) {
          // Process items and fetch product details if needed
          for (const item of so.items) {
            let productName = '';
            let productDescription = '';
            
            // Check if product data is already included
            if (item.product && item.product.name) {
              productName = item.product.name;
              productDescription = item.product.description || '';
            } else if (item.productId) {
              // Fetch product details if not included
              try {
                const productRes = await api.product.getById(item.productId);
                if (productRes.success && productRes.data) {
                  productName = productRes.data.name || productRes.data.productCode || `Product #${item.productId}`;
                  productDescription = productRes.data.description || '';
                } else {
                  productName = `Product #${item.productId}`;
                }
              } catch (error) {
                console.error('Error fetching product:', error);
                productName = `Product #${item.productId}`;
              }
            } else {
              productName = 'Unknown Product';
            }
            
            const lineTotal = (item.quantity || 0) * (item.unitPrice || 0);
            subtotal += lineTotal;
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${productName}</td>
              <td>${productDescription}</td>
              <td>${item.quantity || 0}</td>
              <td>${(item.unitPrice || 0).toFixed(2)}</td>
              <td>${lineTotal.toFixed(2)}</td>
            `;
            tbody.appendChild(tr);
          }
        }
        
        const tax = so.tax || 0;
        const discount = so.discount || 0;
        const total = subtotal + tax - discount;
        document.getElementById('invSubtotal').textContent = subtotal.toFixed(2);
        document.getElementById('invTax').textContent = tax.toFixed(2);
        document.getElementById('invTotal').textContent = total.toFixed(2);
      }

      async function completeInvoiceFlow() {
        const id = document.getElementById('soSelect').value;
        if (!id) return;
        const createRes = await api.invoice.createFromSalesOrder(id, {
          invoiceDate: document.getElementById('invDate').value + 'T00:00:00',
          notes: document.getElementById('invTransRef').value || ''
        });
        if (!createRes.success) {
          utils.showNotification(createRes.error || 'Failed to create invoice', 'error');
          return;
        }
        const invoice = createRes.data;

        const issueRes = await api.invoice.issue(invoice.id);
        if (!issueRes.success) {
          utils.showNotification(issueRes.error || 'Failed to issue invoice', 'error');
          return;
        }

        const payMethod = document.getElementById('invPayment').value;
        if (payMethod) {
          const total = parseFloat(document.getElementById('invTotal').textContent) || 0;
          const payRes = await api.invoice.recordPayment(invoice.id, total);
          if (!payRes.success) {
            utils.showNotification(payRes.error || 'Invoice issued but payment failed', 'warning');
          }
        }

        document.getElementById('invNo').value = invoice.invoiceNumber || ('INV-' + invoice.id);
        utils.showNotification('Invoice completed successfully!', 'success');
      }

      function populatePdfTemplate() {
        // Populate PDF template with current invoice data
        const invNoEl = document.getElementById('pdfInvNo');
        const invDateEl = document.getElementById('pdfInvDate');
        const soRefEl = document.getElementById('pdfSoRef');
        const custNameEl = document.getElementById('pdfCustName');
        const custPhoneEl = document.getElementById('pdfCustPhone');
        const custAddrEl = document.getElementById('pdfCustAddr');
        
        if (invNoEl) invNoEl.textContent = document.getElementById('invNo').value || '-';
        if (invDateEl) invDateEl.textContent = document.getElementById('invDate').value || '-';
        if (soRefEl) soRefEl.textContent = document.getElementById('invSoRef').value || '-';
        if (custNameEl) custNameEl.textContent = document.getElementById('invCustName').value || '-';
        if (custPhoneEl) custPhoneEl.textContent = document.getElementById('invCustPhone').value || '-';
        if (custAddrEl) custAddrEl.textContent = document.getElementById('invCustAddr').value || '-';
        
        // Populate items
        const tbody = document.querySelector('#invItemsTbl tbody');
        const pdfTbody = document.getElementById('pdfItemsBody');
        if (pdfTbody) {
          pdfTbody.innerHTML = '';
          
          if (tbody && tbody.children.length > 0) {
            Array.from(tbody.children).forEach(tr => {
              const cells = tr.querySelectorAll('td');
              if (cells.length >= 5) {
                const pdfTr = document.createElement('tr');
                pdfTr.innerHTML = `
                  <td style="border: 1px solid #000; padding: 10px; color: #000;">${cells[0].textContent || ''}</td>
                  <td style="border: 1px solid #000; padding: 10px; color: #000;">${cells[1].textContent || ''}</td>
                  <td style="border: 1px solid #000; padding: 10px; text-align: right; color: #000;">${cells[2].textContent || '0'}</td>
                  <td style="border: 1px solid #000; padding: 10px; text-align: right; color: #000;">${cells[3].textContent || '0.00'}</td>
                  <td style="border: 1px solid #000; padding: 10px; text-align: right; color: #000;">${cells[4].textContent || '0.00'}</td>
                `;
                pdfTbody.appendChild(pdfTr);
              }
            });
          }
        }
        
        // Populate totals
        const subtotalEl = document.getElementById('pdfSubtotal');
        const taxEl = document.getElementById('pdfTax');
        const discountEl = document.getElementById('pdfDiscount');
        const totalEl = document.getElementById('pdfTotal');
        
        if (subtotalEl) subtotalEl.textContent = document.getElementById('invSubtotal').textContent || '0.00';
        if (taxEl) taxEl.textContent = document.getElementById('invTax').textContent || '0.00';
        const subtotal = parseFloat(document.getElementById('invSubtotal').textContent) || 0;
        const tax = parseFloat(document.getElementById('invTax').textContent) || 0;
        const total = parseFloat(document.getElementById('invTotal').textContent) || 0;
        const discount = subtotal + tax - total;
        if (discountEl) discountEl.textContent = discount.toFixed(2);
        if (totalEl) totalEl.textContent = document.getElementById('invTotal').textContent || '0.00';
        
        console.log('Template populated - Items count:', pdfTbody ? pdfTbody.children.length : 0);
      }

      async function exportPdf() {
        // Check if invoice data is loaded
        const invNo = document.getElementById('invNo').value;
        const soRef = document.getElementById('invSoRef').value;
        
        if (!soRef) {
          utils.showNotification('Please load a Sales Order first.', 'error');
          return;
        }

        try {
          // Show loading indicator
          const exportBtn = document.getElementById('exportInvPdf');
          const originalText = exportBtn.innerHTML;
          exportBtn.disabled = true;
          exportBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating PDF...';

          // Populate PDF template first
          populatePdfTemplate();
          
          // Get the PDF template element
          const element = document.getElementById('pdfTemplate');
          if (!element) {
            throw new Error('PDF template not found');
          }
          
          // Verify data is populated
          const soRefText = document.getElementById('pdfSoRef').textContent;
          const itemsCount = document.getElementById('pdfItemsBody').children.length;
          console.log('PDF Export Debug - SO Ref:', soRefText, 'Items:', itemsCount);
          
          if (soRefText === '-' || itemsCount === 0) {
            throw new Error('No invoice data to export. Please load a Sales Order first.');
          }
          
          // Log template content for debugging
          console.log('PDF Template content:', element.innerHTML.substring(0, 500));

          // Check if html2pdf is available
          if (typeof html2pdf === 'undefined') {
            // Fallback to print
            element.style.display = 'block';
            element.style.visibility = 'visible';
            window.print();
            element.style.display = 'none';
            exportBtn.disabled = false;
            exportBtn.innerHTML = originalText;
            return;
          }

          // Create a new container div for PDF generation
          const pdfContainer = document.createElement('div');
          pdfContainer.id = 'tempPdfContainer';
          pdfContainer.style.cssText = 'position: fixed; top: 0; left: 0; width: 210mm; background: white; z-index: 99999; opacity: 0; pointer-events: none;';
          
          // Clone the template element
          const clonedElement = element.cloneNode(true);
          clonedElement.id = 'clonedPdfTemplate';
          clonedElement.style.cssText = 'display: block; visibility: visible; position: relative; width: 100%; background: white; padding: 20px;';
          
          // Append cloned element to container
          pdfContainer.appendChild(clonedElement);
          
          // Append container to body
          document.body.appendChild(pdfContainer);
          
          // Force layout recalculation
          void pdfContainer.offsetHeight;
          void clonedElement.offsetHeight;
          
          // Wait for rendering
          await new Promise(resolve => setTimeout(resolve, 500));
          
          // Verify cloned content
          const clonedSoRef = clonedElement.querySelector('#pdfSoRef');
          const clonedItems = clonedElement.querySelector('#pdfItemsBody');
          console.log('Cloned element - SO Ref:', clonedSoRef ? clonedSoRef.textContent : 'NOT FOUND');
          console.log('Cloned element - Items:', clonedItems ? clonedItems.children.length : 'NOT FOUND');
          
          if (!clonedSoRef || clonedSoRef.textContent === '-' || !clonedItems || clonedItems.children.length === 0) {
            document.body.removeChild(pdfContainer);
            throw new Error('Failed to clone invoice data. Please try loading the Sales Order again.');
          }

          // Generate PDF with better options - use cloned element
          const invNoClean = (invNo || 'invoice').toString().replace(/\s+/g, '_');
          const opt = {
            margin: [10, 10, 10, 10],
            filename: `${invNoClean}.pdf`,
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: { 
              scale: 2,
              useCORS: true,
              logging: false,
              letterRendering: true,
              backgroundColor: '#ffffff',
              width: clonedElement.scrollWidth,
              height: clonedElement.scrollHeight
            },
            jsPDF: { 
              unit: 'mm', 
              format: 'a4', 
              orientation: 'portrait' 
            }
          };

          // Generate PDF using cloned element
          await html2pdf().set(opt).from(clonedElement).save();
          
          // Wait a bit for download to start
          await new Promise(resolve => setTimeout(resolve, 500));
          
          // Remove temporary container
          if (pdfContainer.parentNode) {
            document.body.removeChild(pdfContainer);
          }

          utils.showNotification('PDF exported successfully!', 'success');
        } catch (error) {
          console.error('PDF export error:', error);
          utils.showNotification('Error generating PDF: ' + error.message, 'error');
          
          // Ensure template is hidden on error
          const element = document.getElementById('pdfTemplate');
          if (element) {
            element.style.display = 'none';
            element.style.visibility = 'hidden';
          }
        } finally {
          // Ensure template is hidden
          const element = document.getElementById('pdfTemplate');
          if (element) {
            element.style.display = 'none';
            element.style.visibility = 'hidden';
            element.style.position = '';
            element.style.left = '';
            element.style.top = '';
            element.style.width = '';
            element.style.height = '';
            element.style.zIndex = '';
            element.style.opacity = '';
          }
          
          // Restore button
          const exportBtn = document.getElementById('exportInvPdf');
          if (exportBtn) {
            exportBtn.disabled = false;
            exportBtn.innerHTML = 'Export PDF';
          }
        }
      }

      document.getElementById('loadSoBtn').addEventListener('click', (e) => { e.preventDefault(); loadSelectedOrder(); });
      document.getElementById('completeInvBtn').addEventListener('click', completeInvoiceFlow);
      document.getElementById('exportInvPdf').addEventListener('click', exportPdf);

      loadSalesOrders();
    </script>
  </body>
</html>
