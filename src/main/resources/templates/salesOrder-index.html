<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sales Order</title>
    <link rel="stylesheet" href="/bootstrap.min.css" />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
      rel="stylesheet"
    />
    <link href="/styles.css" rel="stylesheet" />
  </head>
  <body>
    <div class="container-fluid">
      <div class="row">
        <!-- Sidebar -->
        <div class="col-md-3 col-lg-2">
          <div class="sidebar">
            <div class="p-3">
              <h3 class="text-center mb-4">
                <a href="index.html" class="text-decoration-none text-dark">
                  <img
                    src="/Logo.png"
                    alt="logo"
                    style="width: 60px; height: auto"
                  />
                  Woodcarving
                </a>
              </h3>
            </div>
            <nav class="nav flex-column accordion" id="sidebarAccordion">
              <!-- System Menu -->
              <div class="accordion-item border-0">
                <h2 class="accordion-header" id="headingSystem">
                  <button
                    class="accordion-button bg-light text-dark fw-semibold"
                    type="button"
                    data-bs-toggle="collapse"
                    data-bs-target="#collapseSystem"
                    aria-expanded="true"
                    aria-controls="collapseSystem"
                  >
                    <i class="fas fa-cogs me-2"></i> System
                  </button>
                </h2>
                <div
                  id="collapseSystem"
                  class="accordion-collapse collapse show"
                  aria-labelledby="headingSystem"
                >
                  <div class="accordion-body py-2">
                    <ul class="list-unstyled ps-3 small">
                      <li data-role-required="MANAGER,ADMIN">
                        <a class="nav-link text-dark" href="user-Index.html"
                          ><i class="fas fa-users me-2"></i> User Profile</a
                        >
                      </li>
                      <li>
                        <a class="nav-link text-dark" href="supplier-index.html"
                          ><i class="fas fa-truck me-2"></i> Supplier Profile</a
                        >
                      </li>
                      <li>
                        <a class="nav-link text-dark" href="customer-index.html"
                          ><i class="fas fa-user-friends me-2"></i> Customer
                          Profile</a
                        >
                      </li>
                    </ul>
                  </div>
                </div>
              </div>

              <!-- Maintain Menu -->
              <div class="accordion-item border-0">
                <h2 class="accordion-header" id="headingMaintain">
                  <button
                    class="accordion-button bg-light text-dark fw-semibold"
                    type="button"
                    data-bs-toggle="collapse"
                    data-bs-target="#collapseMaintain"
                    aria-expanded="true"
                    aria-controls="collapseMaintain"
                  >
                    <i class="fas fa-wrench me-2"></i> Inventory
                  </button>
                </h2>
                <div
                  id="collapseMaintain"
                  class="accordion-collapse collapse show"
                  aria-labelledby="headingMaintain"
                >
                  <div class="accordion-body py-2">
                    <ul class="list-unstyled ps-3 small">
                      <li>
                        <a href="item-index.html" class="nav-link text-dark"
                          ><i class="fas fa-hammer me-2"></i> Item Profile</a
                        >
                      </li>
                      <li>
                        <a
                          href="purchaseOrder-index.html"
                          class="nav-link text-dark"
                          ><i class="fas fa-shopping-cart me-2"></i> Purchase
                          Order</a
                        >
                      </li>
                      <li>
                        <a href="grn-index.html" class="nav-link text-dark"
                          ><i class="fas fa-receipt me-2"></i> G.R.N</a
                        >
                      </li>
                    </ul>
                  </div>
                </div>
              </div>

              <!-- Tasks Menu -->
              <div class="accordion-item border-0">
                <h2 class="accordion-header" id="headingTasks">
                  <button
                    class="accordion-button bg-light text-dark fw-semibold"
                    type="button"
                    data-bs-toggle="collapse"
                    data-bs-target="#collapseTasks"
                    aria-expanded="true"
                    aria-controls="collapseTasks"
                  >
                    <i class="fas fa-receipt me-2"></i> Sales
                  </button>
                </h2>
                <div
                  id="collapseTasks"
                  class="accordion-collapse collapse show"
                  aria-labelledby="headingTasks"
                >
                  <div class="accordion-body py-2">
                    <ul class="list-unstyled ps-3 small">
                      <li>
                        <a
                          href="salesOrder-index.html"
                          class="nav-link text-dark"
                          ><i class="fas fa-shopping-bag me-2"></i> Sales
                          Order</a
                        >
                      </li>
                      <li>
                        <a href="invoice-index.html" class="nav-link text-dark"
                          ><i class="fas fa-file-invoice me-2"></i> Invoice</a
                        >
                      </li>
                    </ul>
                  </div>
                </div>
              </div>
            </nav>
          </div>
        </div>

        <!-- Main Content -->
        <div class="col-md-9 col-lg-10">
          <div class="main-content p-4">
            <h2 class="mb-4">Sales Order</h2>

            <div id="errorMessage" class="alert alert-danger d-none" role="alert"></div>
            <div id="successMessage" class="alert alert-success d-none" role="alert"></div>
            <form id="salesOrderForm">
              <div class="row g-3">
                <div class="col-md-6">
                  <div class="card p-3 mb-3">
                    <h5 class="mb-3">Customer Details</h5>
                    <div class="mb-2">
                      <label for="customer" class="form-label">Customer</label>
                      <select id="customer" class="form-select" required>
                        <option value="">Select Customer</option>
                      </select>
                    </div>
                    <div class="mb-2">
                      <label for="customerPhone" class="form-label">Phone</label>
                      <input
                        id="customerPhone"
                        name="customerPhone"
                        type="tel"
                        class="form-control"
                        readonly
                        placeholder="Auto-filled"
                      />
                    </div>
                    <div class="mb-2">
                      <label for="customerAddress" class="form-label">Address</label>
                      <textarea
                        id="customerAddress"
                        name="customerAddress"
                        class="form-control"
                        rows="3"
                        readonly
                        placeholder="Auto-filled"
                      ></textarea>
                    </div>
                  </div>
                </div>

                <div class="col-md-6">
                  <div class="card p-3 mb-3">
                    <h5 class="mb-3">Order Info</h5>
                    <div class="mb-2">
                      <label for="orderDate" class="form-label">Order Date</label>
                      <input
                        id="orderDate"
                        name="orderDate"
                        type="date"
                        class="form-control"
                        required
                      />
                    </div>
                    <div class="mb-2">
                      <label for="expectedDate" class="form-label">Expected Delivery Date</label>
                      <input
                        id="expectedDate"
                        name="expectedDate"
                        type="date"
                        class="form-control"
                        required
                      />
                    </div>
                    <div class="mb-2">
                      <label for="orderRef" class="form-label">Reference</label>
                      <input
                        id="orderRef"
                        name="orderRef"
                        type="text"
                        class="form-control"
                        placeholder="Order reference"
                      />
                    </div>
                  </div>
                </div>
              </div>

              <div class="mt-3">
                <div class="table-responsive">
                  <table
                    class="table table-bordered align-middle"
                    id="itemsTable"
                  >
                    <thead class="table-light">
                      <tr>
                        <th style="width: 25%">Item</th>
                        <th style="width: 10%">Qty</th>
                        <th style="width: 15%">Unit Price</th>
                        <th style="width: 15%">Line Total</th>
                        <th style="width: 10%">Actions</th>
                      </tr>
                    </thead>
                    <tbody id="itemsTableBody">
                      <!-- rows added dynamically -->
                    </tbody>
                  </table>
                </div>

                <div class="d-flex justify-content-between align-items-center mt-3">
                  <div>
                    <button
                      type="button"
                      id="addItemBtn"
                      class="btn btn-sm btn-outline-primary"
                    >
                      <i class="fas fa-plus me-1"></i> Add Item
                    </button>
                  </div>
                  <div class="text-end">
                    <div>Subtotal: <span id="subtotal">0.00</span> LKR</div>
                    <div>
                      <label for="taxInput" class="form-label d-inline">Tax:</label>
                      <input type="number" step="0.01" id="taxInput" class="form-control d-inline-block" style="width: 100px;" value="0" min="0">
                      <span id="tax">0.00</span> LKR
                    </div>
                    <div>
                      <label for="discountInput" class="form-label d-inline">Discount:</label>
                      <input type="number" step="0.01" id="discountInput" class="form-control d-inline-block" style="width: 100px;" value="0" min="0">
                      <span id="discount">0.00</span> LKR
                    </div>
                    <div class="h5 mt-1">
                      Total: <strong id="grandTotal">0.00</strong> LKR
                    </div>
                  </div>
                </div>
              </div>

              <div class="mt-4 text-end">
                <button type="submit" id="saveOrderBtn" class="btn btn-primary">
                  <span id="submitBtnText">Save Order</span>
                </button>
                <button type="button" id="confirmOrderBtn" class="btn btn-success ms-2 d-none">
                  Confirm Order
                </button>
                <button type="button" id="cancelBtn" class="btn btn-secondary ms-2 d-none">
                  Cancel
                </button>
                <button type="reset" class="btn btn-outline-secondary ms-2">
                  Reset
                </button>
              </div>
            </form>

            <hr class="my-5" />

            <h3 class="mb-4">Saved Sales Orders</h3>
            <div class="table-responsive">
              <table class="table table-striped" id="savedOrdersTable">
                <thead class="table-light">
                  <tr>
                    <th>Order No</th>
                    <th>Customer Name</th>
                    <th>Order Date</th>
                    <th>Total</th>
                    <th>Status</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="salesOrderTableBody">
                  <tr>
                    <td colspan="6" class="text-center">Loading...</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <p id="noOrdersMsg" class="text-muted">No saved orders yet.</p>
          </div>
        </div>
      </div>
    </div>

    <script src="/bootstrap.min.js"></script>
    <script src="/api.js"></script>
    <script>
        // Check if user is logged in
        if (!utils.isLoggedIn()) {
            window.location.href = '/login';
        }
        
        let editingOrderId = null;
        let products = [];
        let customers = [];
        
        // Load data on page load
        loadCustomers();
        loadProducts();
        loadSalesOrders();
        setDefaultDate();
        const currentUser = utils.getCurrentUser();
        const isStaff = currentUser && currentUser.role && currentUser.role.toUpperCase() === 'STAFF';
        
        // Set default date to today
        function setDefaultDate() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('orderDate').value = today;
        }
        
        // Load customers
        async function loadCustomers() {
            try {
                const result = await api.customer.getAll();
                if (result.success && result.data) {
                    customers = result.data;
                    const select = document.getElementById('customer');
                    select.innerHTML = '<option value="">Select Customer</option>';
                    customers.forEach(customer => {
                        const option = document.createElement('option');
                        option.value = customer.id;
                        option.textContent = customer.name;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading customers:', error);
            }
        }
        
        // Customer change handler
        document.getElementById('customer').addEventListener('change', function() {
            const customerId = this.value;
            const customer = customers.find(c => c.id == customerId);
            if (customer) {
                document.getElementById('customerPhone').value = customer.phone || '';
                document.getElementById('customerAddress').value = customer.address || '';
            } else {
                document.getElementById('customerPhone').value = '';
                document.getElementById('customerAddress').value = '';
            }
        });
        
        // Load products
        async function loadProducts() {
            try {
                const result = await api.product.getAll();
                if (result.success && result.data) {
                    products = result.data;
                }
            } catch (error) {
                console.error('Error loading products:', error);
            }
        }
        
        // Add item button
        document.getElementById('addItemBtn').addEventListener('click', function() {
            addItemRow();
        });
        
        // Add item row
        function addItemRow() {
            const tbody = document.getElementById('itemsTableBody');
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>
                    <select class="form-select product-select" required>
                        <option value="">Select Product</option>
                        ${products.map(p => `<option value="${p.id}" data-price="${p.sellingPrice || p.price || 0}" data-stock="${p.stock || p.stockQuantity || 0}">${p.name} (${p.productCode}) - Stock: ${p.stock || p.stockQuantity || 0}</option>`).join('')}
                    </select>
                </td>
                <td>
                    <input type="number" class="form-control quantity-input" min="1" value="1" required>
                </td>
                <td>
                    <input type="number" step="0.01" class="form-control unit-price-input" min="0" required>
                </td>
                <td class="line-total-cell">0.00</td>
                <td>
                    <button type="button" class="btn btn-sm btn-danger remove-item-btn">Remove</button>
                </td>
            `;
            tbody.appendChild(row);
            
            // Add event listeners
            const productSelect = row.querySelector('.product-select');
            const quantityInput = row.querySelector('.quantity-input');
            const unitPriceInput = row.querySelector('.unit-price-input');
            
            productSelect.addEventListener('change', function() {
                const selectedOption = this.options[this.selectedIndex];
                const price = selectedOption.getAttribute('data-price');
                const stock = parseInt(selectedOption.getAttribute('data-stock')) || 0;
                unitPriceInput.value = price || 0;
                quantityInput.max = stock;
                if (parseInt(quantityInput.value) > stock) {
                    quantityInput.value = stock;
                }
                calculateRowTotal(row);
            });
            
            quantityInput.addEventListener('input', function() {
                const stock = parseInt(productSelect.options[productSelect.selectedIndex]?.getAttribute('data-stock')) || 0;
                if (parseInt(this.value) > stock) {
                    this.value = stock;
                    alert('Quantity exceeds available stock!');
                }
                calculateRowTotal(row);
            });
            
            unitPriceInput.addEventListener('input', () => calculateRowTotal(row));
            
            row.querySelector('.remove-item-btn').addEventListener('click', function() {
                row.remove();
                calculateTotals();
            });
            
            // Tax and discount change handlers
            document.getElementById('taxInput').addEventListener('input', calculateTotals);
            document.getElementById('discountInput').addEventListener('input', calculateTotals);
        }
        
        // Calculate row total
        function calculateRowTotal(row) {
            const quantity = parseFloat(row.querySelector('.quantity-input').value) || 0;
            const unitPrice = parseFloat(row.querySelector('.unit-price-input').value) || 0;
            const total = quantity * unitPrice;
            row.querySelector('.line-total-cell').textContent = total.toFixed(2);
            calculateTotals();
        }
        
        // Calculate totals
        function calculateTotals() {
            let subtotal = 0;
            document.querySelectorAll('.line-total-cell').forEach(cell => {
                subtotal += parseFloat(cell.textContent) || 0;
            });
            
            const tax = parseFloat(document.getElementById('taxInput').value) || 0;
            const discount = parseFloat(document.getElementById('discountInput').value) || 0;
            
            document.getElementById('subtotal').textContent = subtotal.toFixed(2);
            document.getElementById('tax').textContent = tax.toFixed(2);
            document.getElementById('discount').textContent = discount.toFixed(2);
            
            const grandTotal = subtotal + tax - discount;
            document.getElementById('grandTotal').textContent = grandTotal.toFixed(2);
        }
        
        // Form submit
        document.getElementById('salesOrderForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const items = [];
            document.querySelectorAll('#itemsTableBody tr').forEach(row => {
                const productId = row.querySelector('.product-select').value;
                const quantity = parseInt(row.querySelector('.quantity-input').value);
                const unitPrice = parseFloat(row.querySelector('.unit-price-input').value);
                
                if (productId && quantity && unitPrice) {
                    items.push({
                        productId: parseInt(productId),
                        quantity: quantity,
                        unitPrice: unitPrice
                    });
                }
            });
            
            if (items.length === 0) {
                showError('Please add at least one item');
                return;
            }
            
            const orderData = {
                customerId: parseInt(document.getElementById('customer').value),
                orderDate: document.getElementById('orderDate').value + 'T00:00:00',
                expectedDeliveryDate: document.getElementById('expectedDate').value + 'T00:00:00',
                tax: parseFloat(document.getElementById('taxInput').value) || 0,
                discount: parseFloat(document.getElementById('discountInput').value) || 0,
                notes: document.getElementById('orderRef').value || '',
                items: items
            };
            
            try {
                let result;
                if (editingOrderId) {
                    result = await api.salesOrder.update(editingOrderId, orderData);
                } else {
                    result = await api.salesOrder.create(orderData);
                }
                
                if (result.success) {
                    utils.showNotification(editingOrderId ? 'Sales Order updated successfully!' : 'Sales Order created successfully!', 'success');
                    resetForm();
                    loadSalesOrders();
                } else {
                    showError(result.error || 'Failed to save sales order');
                }
            } catch (error) {
                showError('An error occurred. Please try again.');
            }
        });
        
        // Confirm order button
        document.getElementById('confirmOrderBtn').addEventListener('click', async function() {
            if (confirm('Confirm this sales order? This will deduct stock from inventory.')) {
                try {
                    const result = await api.salesOrder.confirm(editingOrderId);
                    if (result.success) {
                        utils.showNotification('Sales Order confirmed successfully! Stock deducted.', 'success');
                        resetForm();
                        loadSalesOrders();
                    } else {
                        showError(result.error || 'Failed to confirm sales order');
                    }
                } catch (error) {
                    showError('Error confirming sales order: ' + error.message);
                }
            }
        });
        
        // Load sales orders
        async function loadSalesOrders() {
            try {
                const result = await api.salesOrder.getAll();
                const tbody = document.getElementById('salesOrderTableBody');
                
                if (result.success && result.data && result.data.length > 0) {
                    tbody.innerHTML = result.data.map(order => `
                        <tr>
                            <td>${order.orderNumber || 'N/A'}</td>
                            <td>${order.customer ? order.customer.name : 'N/A'}</td>
                            <td>${formatDate(order.orderDate)}</td>
                            <td>${(order.totalAmount || 0).toFixed(2)} LKR</td>
                            <td><span class="badge bg-${getStatusColor(order.status)}">${order.status || 'PENDING'}</span></td>
                            <td>
                                ${(!isStaff && order.status === 'PENDING') ? `<button class="btn btn-sm btn-success me-2" onclick="confirmSalesOrder(${order.id})">Confirm</button>` : ''}
                                <button class="btn btn-sm btn-info me-2" onclick="viewSalesOrder(${order.id})">View</button>
                                ${(!isStaff && order.status === 'PENDING') ? `<button class="btn btn-sm btn-warning me-2" onclick="editSalesOrder(${order.id})">Edit</button>` : ''}
                                ${(!isStaff && order.status === 'PENDING') ? `<button class="btn btn-sm btn-danger" onclick="deleteSalesOrder(${order.id})">Delete</button>` : ''}
                            </td>
                        </tr>
                    `).join('');
                    document.getElementById('noOrdersMsg').classList.add('d-none');
                } else {
                    tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No sales orders found</td></tr>';
                    document.getElementById('noOrdersMsg').classList.remove('d-none');
                }
            } catch (error) {
                document.getElementById('salesOrderTableBody').innerHTML = 
                    '<tr><td colspan="6" class="text-center text-danger">Error loading sales orders</td></tr>';
            }
        }
        
        // View sales order
        async function viewSalesOrder(id) {
            try {
                const result = await api.salesOrder.getById(id);
                if (result.success) {
                    const order = result.data;
                    alert(`Sales Order Details:\n\nOrder Number: ${order.orderNumber}\nCustomer: ${order.customer ? order.customer.name : 'N/A'}\nStatus: ${order.status}\nTotal: ${order.totalAmount || 0} LKR`);
                }
            } catch (error) {
                showError('Error loading sales order');
            }
        }
        
        // Edit sales order
        async function editSalesOrder(id) {
            try {
                const result = await api.salesOrder.getById(id);
                if (result.success) {
                    const order = result.data;
                    editingOrderId = order.id;
                    document.getElementById('customer').value = order.customerId || '';
                    document.getElementById('customer').dispatchEvent(new Event('change'));
                    document.getElementById('orderDate').value = order.orderDate ? order.orderDate.split('T')[0] : '';
                    document.getElementById('expectedDate').value = order.expectedDeliveryDate ? order.expectedDeliveryDate.split('T')[0] : '';
                    document.getElementById('orderRef').value = order.notes || '';
                    document.getElementById('taxInput').value = order.tax || 0;
                    document.getElementById('discountInput').value = order.discount || 0;
                    
                    // Clear and populate items
                    document.getElementById('itemsTableBody').innerHTML = '';
                    if (order.items && order.items.length > 0) {
                        order.items.forEach(item => {
                            addItemRow();
                            const lastRow = document.querySelector('#itemsTableBody tr:last-child');
                            lastRow.querySelector('.product-select').value = item.productId;
                            lastRow.querySelector('.quantity-input').value = item.quantity;
                            lastRow.querySelector('.unit-price-input').value = item.unitPrice;
                            calculateRowTotal(lastRow);
                        });
                    }
                    calculateTotals();
                    
                    document.getElementById('submitBtnText').textContent = 'Update Order';
                    if (!isStaff) {
                      document.getElementById('confirmOrderBtn').classList.remove('d-none');
                    }
                    document.getElementById('cancelBtn').classList.remove('d-none');
                    document.getElementById('salesOrderForm').scrollIntoView({ behavior: 'smooth' });
                }
            } catch (error) {
                showError('Error loading sales order data');
            }
        }
        
        // Confirm sales order
        async function confirmSalesOrder(id) {
            if (confirm('Confirm this sales order? This will deduct stock from inventory.')) {
                try {
                    const result = await api.salesOrder.confirm(id);
                    if (result.success) {
                        utils.showNotification('Sales Order confirmed successfully! Stock deducted.', 'success');
                        loadSalesOrders();
                    } else {
                        showError(result.error || 'Failed to confirm sales order');
                    }
                } catch (error) {
                    showError('Error confirming sales order: ' + error.message);
                }
            }
        }
        
        // Delete sales order
        async function deleteSalesOrder(id) {
            if (confirm('Are you sure you want to delete this sales order?')) {
                try {
                    const result = await api.salesOrder.delete(id);
                    if (result && result.success) {
                        utils.showNotification('Sales Order deleted successfully!', 'success');
                        loadSalesOrders();
                    } else {
                        utils.showNotification('Sales Order deleted successfully!', 'success');
                        loadSalesOrders();
                    }
                } catch (error) {
                    showError('Error deleting sales order: ' + error.message);
                }
            }
        }
        
        // Reset form
        function resetForm() {
            editingOrderId = null;
            document.getElementById('salesOrderForm').reset();
            document.getElementById('itemsTableBody').innerHTML = '';
            document.getElementById('subtotal').textContent = '0.00';
            document.getElementById('tax').textContent = '0.00';
            document.getElementById('discount').textContent = '0.00';
            document.getElementById('grandTotal').textContent = '0.00';
            document.getElementById('submitBtnText').textContent = 'Save Order';
            document.getElementById('confirmOrderBtn').classList.add('d-none');
            document.getElementById('cancelBtn').classList.add('d-none');
            setDefaultDate();
            hideMessages();
        }
        
        // Cancel edit
        document.getElementById('cancelBtn').addEventListener('click', resetForm);
        
        // Helper functions
        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            return date.toLocaleDateString();
        }
        
        function getStatusColor(status) {
            const colors = {
                'PENDING': 'warning',
                'CONFIRMED': 'info',
                'SHIPPED': 'primary',
                'DELIVERED': 'success',
                'CANCELLED': 'danger'
            };
            return colors[status] || 'secondary';
        }
        
        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.classList.remove('d-none');
            document.getElementById('successMessage').classList.add('d-none');
        }
        
        function hideMessages() {
            document.getElementById('errorMessage').classList.add('d-none');
            document.getElementById('successMessage').classList.add('d-none');
        }
    </script>
  </body>
</html>
