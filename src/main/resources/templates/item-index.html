<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Items</title>
    <link rel="stylesheet" href="/bootstrap.min.css" />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
      rel="stylesheet"
    />
    <link href="/styles.css" rel="stylesheet" />
  </head>
  <body>
    <div class="container-fluid">
      <div class="row">
        <!-- Sidebar -->
        <div class="col-md-3 col-lg-2">
          <div class="sidebar">
            <div class="p-3">
              <h3 class="text-center mb-4">
                <a href="index.html" class="text-decoration-none text-dark">
                  <img src="/Logo.png" alt="logo" style="width: 60px; height: auto;"> Woodcarving
                </a>
              </h3>
            </div>
            <nav class="nav flex-column accordion" id="sidebarAccordion">
              <!-- System Menu -->
              <div class="accordion-item border-0">
                <h2 class="accordion-header" id="headingSystem">
                  <button
                    class="accordion-button bg-light text-dark fw-semibold"
                    type="button"
                    data-bs-toggle="collapse"
                    data-bs-target="#collapseSystem"
                    aria-expanded="true"
                    aria-controls="collapseSystem"
                  >
                    <i class="fas fa-cogs me-2"></i> System
                  </button>
                </h2>
                <div
                  id="collapseSystem"
                  class="accordion-collapse collapse show"
                  aria-labelledby="headingSystem"
                >
                  <div class="accordion-body py-2">
                    <ul class="list-unstyled ps-3 small">
                      <li data-role-required="MANAGER,ADMIN">
                        <a class="nav-link text-dark" href="user-Index.html"
                          ><i class="fas fa-users me-2"></i> User Profile</a
                        >
                      </li>
                      <li>
                        <a class="nav-link text-dark" href="supplier-index.html"
                          ><i class="fas fa-truck me-2"></i> Supplier Profile</a
                        >
                      </li>
                      <li>
                        <a class="nav-link text-dark" href="customer-index.html"
                          ><i class="fas fa-user-friends me-2"></i> Customer
                          Profile</a
                        >
                      </li>
                    </ul>
                  </div>
                </div>
              </div>

              <!-- Maintain Menu -->
              <div class="accordion-item border-0">
                <h2 class="accordion-header" id="headingMaintain">
                  <button
                    class="accordion-button bg-light text-dark fw-semibold"
                    type="button"
                    data-bs-toggle="collapse"
                    data-bs-target="#collapseMaintain"
                    aria-expanded="true"
                    aria-controls="collapseMaintain"
                  >
                    <i class="fas fa-wrench me-2"></i> Inventory
                  </button>
                </h2>
                <div
                  id="collapseMaintain"
                  class="accordion-collapse collapse show"
                  aria-labelledby="headingMaintain"
                >
                  <div class="accordion-body py-2">
                    <ul class="list-unstyled ps-3 small">
                      <li>
                        <a href="item-index.html" class="nav-link text-dark"
                          ><i class="fas fa-hammer me-2"></i> Item Profile</a
                        >
                      </li>
                      <li>
                        <a href="purchaseOrder-index.html" class="nav-link text-dark"
                          ><i class="fas fa-shopping-cart me-2"></i> Purchase
                          Order</a
                        >
                      </li>
                      <li>
                        <a href="grn-index.html" class="nav-link text-dark"
                          ><i class="fas fa-receipt me-2"></i> G.R.N</a
                        >
                      </li>
                    </ul>
                  </div>
                </div>
              </div>

              <!-- Tasks Menu -->
              <div class="accordion-item border-0">
                <h2 class="accordion-header" id="headingTasks">
                  <button
                    class="accordion-button bg-light text-dark fw-semibold"
                    type="button"
                    data-bs-toggle="collapse"
                    data-bs-target="#collapseTasks"
                    aria-expanded="true"
                    aria-controls="collapseTasks"
                  >
                    <i class="fas fa-receipt me-2"></i> Sales
                  </button>
                </h2>
                <div
                  id="collapseTasks"
                  class="accordion-collapse collapse show"
                  aria-labelledby="headingTasks"
                >
                  <div class="accordion-body py-2">
                    <ul class="list-unstyled ps-3 small">
                      <li>
                        <a href="salesOrder-index.html" class="nav-link text-dark"
                          ><i class="fas fa-shopping-bag me-2"></i> Sales
                          Order</a
                        >
                      </li>
                      <li>
                        <a href="invoice-index.html" class="nav-link text-dark"
                          ><i class="fas fa-file-invoice me-2"></i> Invoice</a
                        >
                      </li>
                    </ul>
                  </div>
                </div>
              </div>
            </nav>
          </div>
        </div>

        <!-- Main Content -->
        <div class="col-md-9 col-lg-10">
          <div class="main-content container-fluid">
            <div class="row">
              <div class="col-lg-12">
                <div class="card">
                  <div class="card-header">
                    <h5>Add Item</h5>
                  </div>
                  <div class="card-body">
                    <div id="errorMessage" class="alert alert-danger d-none" role="alert"></div>
                    <div id="successMessage" class="alert alert-success d-none" role="alert"></div>
                    <form id="productForm">
                      <div class="row">
                        <div class="col-md-2 mb-3">
                          <label for="productCode" class="form-label">Product Code</label>
                          <input
                                  type="text"
                                  class="form-control"
                                  id="productCode"
                                  placeholder="e.g., WC001"
                                  required
                          />
                        </div>
                        <div class="col-md-2 mb-3">
                          <label for="itemName" class="form-label">Item Name</label>
                          <input
                                  type="text"
                                  class="form-control"
                                  id="itemName"
                                  placeholder="Enter item name"
                                  required
                          />
                        </div>
                        <div class="col-md-2 mb-3">
                          <label for="itemType" class="form-label">Item Type</label>
                          <select class="form-select" id="itemType" required>
                            <option value="">Select item type</option>
                            <option value="Furniture">Furniture</option>
                            <option value="Boxes">Boxes</option>
                            <option value="Miniature models">Miniature models</option>
                            <option value="Statues">Statues</option>
                            <option value="Other">Other</option>
                          </select>
                        </div>
                        <div class="col-md-2 mb-3">
                          <label for="finishedType" class="form-label">Finished Type</label>
                          <select class="form-select" id="finishedType" required>
                            <option value="">Select Finished Type</option>
                            <option value="Oil">Oil</option>
                            <option value="Wax">Wax</option>
                            <option value="Varnish">Varnish</option>
                            <option value="Polished">Polished</option>
                            <option value="Painted">Painted</option>
                            <option value="Other">Other</option>
                          </select>
                        </div>
                        <div class="col-md-2 mb-3">
                          <label for="woodType" class="form-label">Wood Type</label>
                          <select class="form-select" id="woodType" required>
                            <option value="">Select wood type</option>
                            <option value="Teak">Teak</option>
                            <option value="Mahogany">Mahogany</option>
                            <option value="Rosewood">Rosewood</option>
                            <option value="Cedar">Cedar</option>
                            <option value="Other">Other</option>
                          </select>
                        </div>
                        <div class="col-md-2 mb-3">
                          <label for="category" class="form-label">Category</label>
                          <input
                                  type="text"
                                  class="form-control"
                                  id="category"
                                  placeholder="e.g., Statues"
                                  required
                          />
                        </div>
                      </div>
                      <div class="row">
                        <div class="col-md-2 mb-3">
                          <div class="form-check form-switch mt-4">
                            <input class="form-check-input" type="checkbox" id="is_carved">
                            <label class="form-check-label" for="is_carved">
                              Carved
                            </label>
                          </div>
                        </div>
                        <div class="col-md-2 mb-3">
                          <label for="costPrice" class="form-label">Cost Price (LKR)</label>
                          <input
                                  type="number"
                                  step="0.01"
                                  class="form-control"
                                  id="costPrice"
                                  placeholder="Enter cost price"
                                  required
                            />
                        </div>
                        <div class="col-md-2 mb-3">
                          <label for="sellingPrice" class="form-label">Selling Price (LKR)</label>
                          <input
                                  type="number"
                                  step="0.01"
                                  class="form-control"
                                  id="sellingPrice"
                                  placeholder="Enter selling price"
                                  required
                            />
                        </div>
                        <div class="col-md-2 mb-3">
                          <label for="stock" class="form-label">Stock</label>
                          <input
                                  type="number"
                                  class="form-control"
                                  id="stock"
                                  placeholder="Enter stock quantity"
                                  required
                            />
                        </div>
                        <div class="col-md-2 mb-3">
                          <label for="minStockLevel" class="form-label">Min Stock Level</label>
                          <input
                                  type="number"
                                  class="form-control"
                                  id="minStockLevel"
                                  placeholder="Min stock"
                                  required
                            />
                        </div>
                        <div class="col-md-2 mb-3 align-self-end">
                          <button type="submit" class="btn btn-primary w-100" id="submitBtn">
                            <span id="submitBtnText">Add Item</span>
                          </button>
                          <button type="button" class="btn btn-secondary w-100 mt-2 d-none" id="cancelBtn">
                            Cancel
                          </button>
                        </div>
                      </div>
                      <div class="row">
                        <div class="col-md-6 mb-3">
                          <label for="description" class="form-label">Description</label>
                          <textarea
                                  class="form-control"
                                  id="description"
                                  rows="2"
                                  placeholder="Enter description"
                          ></textarea>
                        </div>
                        <div class="col-md-3 mb-3">
                          <label for="dimensions" class="form-label">Dimensions</label>
                          <input
                                  type="text"
                                  class="form-control"
                                  id="dimensions"
                                  placeholder="e.g., 12x8x20 inches"
                                  required
                            />
                        </div>
                        <div class="col-md-3 mb-3">
                          <label for="weight" class="form-label">Weight (kg)</label>
                          <input
                                  type="number"
                                  step="0.01"
                                  class="form-control"
                                  id="weight"
                                  placeholder="Enter weight"
                                  required
                            />
                        </div>
                      </div>
                    </form>
                  </div>
                </div>
              </div>
            </div>

            <div class="row mt-3">
              <div class="col-lg-12">
                <div class="card">
                  <div class="card-header">
                    <h5>Item List</h5>
                  </div>
                  <div class="card-body">
                    <div class="mb-3">
                      <input
                        type="text"
                        class="form-control"
                        id="productSearchInput"
                        placeholder="Search items by name, code, category, wood type..."
                      />
                    </div>
                    <table class="table table-striped">
                      <thead>
                        <tr>
                          <th scope="col">Item ID</th>
                          <th scope="col">Item Name</th>
                          <th scope="col">Item Type</th>
                          <th scope="col">Finished Type</th>
                          <th scope="col">Wood Type</th>
                          <th scope="col">Carved</th>
                          <th scope="col">Cost Price (LKR)</th>
                          <th scope="col">Selling Price (LKR)</th>
                          <th scope="col">Stock</th>
                          <th scope="col">Actions</th>
                        </tr>
                      </thead>
                      <tbody id="productTableBody">
                        <tr>
                          <td colspan="10" class="text-center">Loading...</td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="/bootstrap.min.js"></script>
    <script src="/api.js"></script>
    <script>
        // Check if user is logged in
        if (!utils.isLoggedIn()) {
            window.location.href = '/login';
        }
        
        let editingProductId = null;
        
        // Load products on page load
        loadProducts();
        
        // Form submit handler
        document.getElementById('productForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const productData = {
                productCode: document.getElementById('productCode').value,
                name: document.getElementById('itemName').value,
                description: document.getElementById('description').value || '',
                category: document.getElementById('category').value,
                itemType: document.getElementById('itemType').value,
                woodType: document.getElementById('woodType').value,
                finishedType: document.getElementById('finishedType').value,
                isCarved: document.getElementById('is_carved').checked,
                cost: parseFloat(document.getElementById('costPrice').value),
                sellingPrice: parseFloat(document.getElementById('sellingPrice').value),
                stock: parseInt(document.getElementById('stock').value),
                minStockLevel: parseInt(document.getElementById('minStockLevel').value),
                dimensions: document.getElementById('dimensions').value,
                weight: parseFloat(document.getElementById('weight').value)
            };
            
            try {
                let result;
                if (editingProductId) {
                    result = await api.product.update(editingProductId, productData);
                } else {
                    result = await api.product.create(productData);
                }
                
                if (result.success) {
                    utils.showNotification(editingProductId ? 'Product updated successfully!' : 'Product created successfully!', 'success');
                    resetForm();
                    loadProducts();
                } else {
                    showError(result.error || 'Failed to save product');
                }
            } catch (error) {
                showError('An error occurred. Please try again.');
            }
        });
        
        // Load all products
        async function loadProducts() {
            try {
                const result = await api.product.getAll();
                const tbody = document.getElementById('productTableBody');
                
                if (result.success && result.data && result.data.length > 0) {
                    tbody.innerHTML = result.data.map(product => `
                        <tr>
                            <td>${product.productCode}</td>
                            <td>${product.name}</td>
                            <td>${product.itemType || 'N/A'}</td>
                            <td>${product.finishedType || 'N/A'}</td>
                            <td>${product.woodType}</td>
                            <td>${product.isCarved ? 'Yes' : 'No'}</td>
                            <td>${product.cost || 0}</td>
                            <td>${product.sellingPrice || product.price || 0}</td>
                            <td><span class="badge ${product.stock <= product.minStockLevel ? 'bg-danger' : 'bg-success'}">${product.stock || product.stockQuantity || 0}</span></td>
                            <td>
                                <button class="btn btn-sm btn-warning me-2" onclick="editProduct(${product.id})">Edit</button>
                                <button class="btn btn-sm btn-danger" onclick="deleteProduct(${product.id})">Delete</button>
                            </td>
                        </tr>
                    `).join('');
                } else {
                    tbody.innerHTML = '<tr><td colspan="10" class="text-center text-muted">No products found</td></tr>';
                }
            } catch (error) {
                document.getElementById('productTableBody').innerHTML = 
                    '<tr><td colspan="10" class="text-center text-danger">Error loading products</td></tr>';
            }
        }
        
        // Edit product
        async function editProduct(id) {
            try {
                const result = await api.product.getById(id);
                if (result.success) {
                    const product = result.data;
                    editingProductId = product.id;
                    document.getElementById('productCode').value = product.productCode || '';
                    document.getElementById('productCode').readOnly = true;
                    document.getElementById('itemName').value = product.name || '';
                    document.getElementById('description').value = product.description || '';
                    document.getElementById('category').value = product.category || '';
                    document.getElementById('itemType').value = product.itemType || '';
                    document.getElementById('woodType').value = product.woodType || '';
                    document.getElementById('finishedType').value = product.finishedType || '';
                    document.getElementById('is_carved').checked = product.isCarved || false;
                    document.getElementById('costPrice').value = product.cost || '';
                    document.getElementById('sellingPrice').value = product.sellingPrice || product.price || '';
                    document.getElementById('stock').value = product.stock || product.stockQuantity || '';
                    document.getElementById('minStockLevel').value = product.minStockLevel || '';
                    document.getElementById('dimensions').value = product.dimensions || '';
                    document.getElementById('weight').value = product.weight || '';
                    document.getElementById('submitBtnText').textContent = 'Update Item';
                    document.getElementById('cancelBtn').classList.remove('d-none');
                    document.getElementById('productForm').scrollIntoView({ behavior: 'smooth' });
                }
            } catch (error) {
                showError('Error loading product data');
            }
        }
        
        // Delete product
        async function deleteProduct(id) {
            if (confirm('Are you sure you want to delete this product?')) {
                try {
                    const result = await api.product.delete(id);
                    if (result && result.success) {
                        utils.showNotification('Product deleted successfully!', 'success');
                        loadProducts();
                    } else if (result && !result.success) {
                        showError(result.error || 'Failed to delete product');
                    } else {
                        utils.showNotification('Product deleted successfully!', 'success');
                        loadProducts();
                    }
                } catch (error) {
                    showError('Error deleting product: ' + error.message);
                }
            }
        }
        
        // Reset form
        function resetForm() {
            editingProductId = null;
            document.getElementById('productForm').reset();
            document.getElementById('productCode').readOnly = false;
            document.getElementById('submitBtnText').textContent = 'Add Item';
            document.getElementById('cancelBtn').classList.add('d-none');
            hideMessages();
        }
        
        // Cancel edit
        document.getElementById('cancelBtn').addEventListener('click', resetForm);
        
        // Show/hide error messages
        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.classList.remove('d-none');
            document.getElementById('successMessage').classList.add('d-none');
        }
        
        function hideMessages() {
            document.getElementById('errorMessage').classList.add('d-none');
            document.getElementById('successMessage').classList.add('d-none');
        }

        // Search functionality for products
        document.getElementById('productSearchInput').addEventListener('keyup', function() {
            filterProducts();
        });

        function filterProducts() {
            const input = document.getElementById('productSearchInput');
            const filter = input.value.toLowerCase();
            const table = document.getElementById('productTableBody');
            const rows = table.getElementsByTagName('tr');

            for (let i = 0; i < rows.length; i++) {
                const row = rows[i];
                const text = row.textContent || row.innerText;
                if (text.toLowerCase().indexOf(filter) > -1) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            }
        }
    </script>
  </body>
</html>
